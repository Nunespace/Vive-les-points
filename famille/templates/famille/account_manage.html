{% extends "base.html" %}

{% block content %}
<div class="container my-4 pb-5">
  <h1 class="page-title display-6 mb-3">
    <span class="title-chip">Mon compte famille</span>
  </h1>


  <form method="post" novalidate autocomplete="off">
    {% csrf_token %}

    <div class="card mb-4">
      <div class="card-header fw-semibold">Famille</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Nom de la famille</label>
          {{ famille_form.nom }}
          <div class="text-danger small">{{ famille_form.nom.errors }}</div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Parents</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-parent">+ Ajouter un parent</button>
      </div>
      <div class="card-body" id="parents-container">
        {{ parent_formset.management_form }}
        {% if parent_formset.non_form_errors %}
        <div class="alert alert-warning mb-3">
          {% for err in parent_formset.non_form_errors %}<div>{{ err }}</div>{% endfor %}
        </div>
      {% endif %}

        {% for form in parent_formset %}
          <div class="border rounded p-3 mb-3 parent-form">
            {{ form.user_id }}
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Prénom</label>{{ form.first_name }}
                <div class="text-danger small">{{ form.first_name.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Nom</label>{{ form.last_name }}
                <div class="text-danger small">{{ form.last_name.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Email</label>{{ form.email }}
                <div class="text-danger small">{{ form.email.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Nouveau mot de passe</label>
                <div class="input-group">
                  {{ form.new_password }}
                  <button class="btn btn-outline-secondary toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                <div class="form-text js-pwd-help">Laisser vide pour conserver le mot de passe actuel.</div>
                <div class="text-danger small">{{ form.new_password.errors }}</div>
              </div>
            <div class="form-check mt-2">
              {{ form.DELETE }} <label class="form-check-label">Retirer ce parent (données supprimées)</label>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Enfants</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-enfant">+ Ajouter un enfant</button>
      </div>
      <div class="card-body" id="enfants-container">
      {{ enfant_formset.management_form }}
      {% for form in enfant_formset.forms %}
        <div class="border rounded p-3 mb-3 enfant-form">
          {{ form.id }}
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Prénom</label>{{ form.prenom }}
              <div class="text-danger small">{{ form.prenom.errors }}</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Email (facultatif)</label>{{ form.email }}
              <div class="text-danger small">{{ form.email.errors }}</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Mot de passe</label>
              <div class="input-group">
                {{ form.new_password }}
                <button class="btn btn-outline-secondary toggle-password" type="button">
                  <i class="bi bi-eye"></i>
                </button>
              </div>

              {# ▼▼▼ message contextuel + classe hook ▼▼▼ #}
              {% if form.instance.pk %}
                <div class="form-text js-enfant-pwd-help">
                  Laisser vide pour conserver le mot de passe actuel.
                </div>
              {% else %}
                <div class="form-text js-enfant-pwd-help">
                  Choisir un mot de passe si vous renseignez l'email de l'enfant.
                </div>
              {% endif %}

              <div class="text-danger small">{{ form.new_password.errors }}</div>
            </div>

          </div>
          <div class="form-check mt-2">
            {{ form.DELETE }} <label class="form-check-label">Retirer de la famille</label>
          </div>
        </div>
      {% endfor %}
      </div>
    </div>

    <div class="d-flex gap-2 justify-content-end">
      <button type="submit" class="btn btn-primary">Enregistrer</button>
    </div>
  </form>

  <form method="post" class="mt-4"
        onsubmit="return confirm('Supprimer TOUS les comptes de votre famille (parents + enfants) ? Cette action est irréversible.');">
    {% csrf_token %}
    <input type="hidden" name="delete_family" value="1">
    <button class="btn btn-outline-danger">Supprimer tous les comptes de ma famille</button>
  </form>

</div>

<script>
  // --- Helpers --------------------------------------------------------------
  function renameFormsetBlock(block, prefix, index) {
    const re = new RegExp(`${prefix}-\\d+-`, 'g');
    block.querySelectorAll('[name^="'+prefix+'-"], [id^="'+prefix+'-"]').forEach(el => {
      if (el.name) el.name = el.name.replace(re, `${prefix}-${index}-`);
      if (el.id)   el.id   = el.id.replace(re, `${prefix}-${index}-`);
    });
  }

  function resetInputs(block) {
    block.querySelectorAll('input').forEach(inp => {
      if (inp.type === 'checkbox') { inp.checked = false; return; }
      inp.value = '';
    });
  }

  // --- Config UI pour un bloc "enfant" (existant vs nouveau) -----------------
function configureEnfantBlock(block) {
  const idInput = block.querySelector('input[name$="-id"]');              // id de l'objet Enfant
  const email   = block.querySelector('input[name$="-email"]');
  const pwd     = block.querySelector('input[name$="-new_password"]');
  const help    = block.querySelector('.js-enfant-pwd-help');
  const isExisting = !!(idInput && idInput.value);

  if (!pwd) return;

  if (isExisting) {
    // Enfant existant
    pwd.required = false;
    pwd.placeholder = "Laisser vide pour conserver";
    if (help) help.textContent = "Laisser vide pour conserver le mot de passe actuel.";
    if (email) {
      // Sur un existant, le mdp reste facultatif même si on change l'email
      email.addEventListener('input', () => { pwd.required = false; });
    }
  } else {
    // Nouvel enfant : mdp seulement si un email est saisi
    pwd.required = !!(email && email.value.trim() !== "");
    pwd.placeholder = ""; // pas de texte "laisser vide"
    if (help) help.textContent = "Choisir un mot de passe si vous renseignez l'email de l'enfant.";
    if (email) {
      email.addEventListener('input', () => {
        pwd.required = email.value.trim() !== "";
      });
    }
  }
}


  // --- Config UI pour un bloc "parent" (existant vs nouveau) ---------------
  function configureParentBlock(block) {
    const userId = block.querySelector('input[name$="-user_id"]');
    const pwd    = block.querySelector('input[name$="-new_password"]');
    const help   = block.querySelector('.js-pwd-help');
    const del    = block.querySelector('input[name$="-DELETE"]');
    const isExisting = !!(userId && userId.value);

    if (pwd) {
      if (isExisting) {
        pwd.required = false;
        pwd.placeholder = "Laisser vide pour conserver";
        if (help) help.textContent = "Laisser vide pour conserver le mot de passe actuel.";
      } else {
        pwd.required = true;
        pwd.placeholder = "Choisir un mot de passe";
        if (help) help.textContent = "Mot de passe requis pour un nouveau parent.";
      }
    }
    if (del && pwd) {
      del.addEventListener('change', () => {
        // si on supprime un nouveau parent, ne bloque pas sur required
        pwd.required = !isExisting && !del.checked;
      });
    }
  }

  // --- Délégation : bouton œil pour tous les champs mdp --------------------
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.toggle-password');
    if (!btn) return;
    const input = btn.closest('.input-group')?.querySelector('input');
    if (!input) return;
    input.type = input.type === 'password' ? 'text' : 'password';
  });

  // --- Config initiale des blocs existants ---------------------------------
  document.querySelectorAll('#parents-container .parent-form').forEach(configureParentBlock);
  document.querySelectorAll('#enfants-container .enfant-form').forEach(configureEnfantBlock);

  // --- Ajout d'un PARENT ----------------------------------------------------
  document.getElementById('add-parent').addEventListener('click', () => {
    const container  = document.getElementById('parents-container');
    const totalInput = container.querySelector('input[name="parents-TOTAL_FORMS"]');
    const index      = parseInt(totalInput.value, 10);

    const first  = container.querySelector('.parent-form');
    const clone  = first.cloneNode(true);

    // reset et reindex
    resetInputs(clone);
    renameFormsetBlock(clone, 'parents', index);

    // s'assurer que user_id est vide (nouvelle ligne)
    const userId = clone.querySelector('input[name$="-user_id"]');
    if (userId) userId.value = '';

    container.appendChild(clone);
    totalInput.value = index + 1;

    configureParentBlock(clone);
  });

  // --- Ajout d'un ENFANT ----------------------------------------------------
  document.getElementById('add-enfant').addEventListener('click', () => {
    const container  = document.getElementById('enfants-container');
    const totalInput = container.querySelector('input[name="enfants-TOTAL_FORMS"]');
    const index      = parseInt(totalInput.value, 10);

    const first  = container.querySelector('.enfant-form');
    const clone  = first.cloneNode(true);

    resetInputs(clone);
    renameFormsetBlock(clone, 'enfants', index);

    // Important : un nouveau bloc enfant n'a PAS d'id => c'est un "nouveau"
    const idInput = clone.querySelector('input[name$="-id"]');
    if (idInput) idInput.value = "";

    container.appendChild(clone);
    totalInput.value = index + 1;

    configureEnfantBlock(clone);
  });

</script>

{% endblock %}

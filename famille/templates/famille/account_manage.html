{% extends "base.html" %}

{% block content %}
<div class="container my-4 pb-5">
  <h1 class="page-title display-6 mb-3">
    <span class="title-chip">Mon compte famille</span>
  </h1>

  {# Bloc global d'erreurs #}
  {% if famille_form.errors or parent_formset.errors or parent_formset.non_form_errors or enfant_formset.errors or enfant_formset.non_form_errors %}
    <div class="alert alert-danger">
      <strong>Merci de corriger les erreurs suivantes :</strong>
      <ul class="mb-0">
        {# … erreurs inchangées … #}
      </ul>
    </div>
  {% endif %}

  <form method="post" novalidate autocomplete="off">
    {% csrf_token %}

    <div class="card mb-4">
      <div class="card-header fw-semibold">Famille</div>
      <div class="card-body">
        <div class="mb-3">
          <label class="form-label">Nom de la famille</label>
          {{ famille_form.nom }}
          <div class="text-danger small">{{ famille_form.nom.errors }}</div>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Parents</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-parent">+ Ajouter un parent</button>
      </div>
      <div class="card-body" id="parents-container">
        {{ parent_formset.management_form }}
        {% for form in parent_formset %}
          <div class="border rounded p-3 mb-3 parent-form">
            {{ form.user_id }}
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Prénom</label>{{ form.first_name }}
                <div class="text-danger small">{{ form.first_name.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Nom</label>{{ form.last_name }}
                <div class="text-danger small">{{ form.last_name.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Email</label>{{ form.email }}
                <div class="text-danger small">{{ form.email.errors }}</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Nouveau mot de passe</label>
                <div class="input-group">
                  {{ form.new_password }}
                  <button class="btn btn-outline-secondary toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                <div class="form-text">Laisser vide pour conserver le mot de passe actuel.</div>
                <div class="text-danger small">{{ form.new_password.errors }}</div>
              </div>
            <div class="form-check mt-2">
              {{ form.DELETE }} <label class="form-check-label">Retirer ce parent (données supprimées)</label>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold">Enfants</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-enfant">+ Ajouter un enfant</button>
      </div>
      <div class="card-body" id="enfants-container">
      {{ enfant_formset.management_form }}
      {% for form in enfant_formset.forms %}
        <div class="border rounded p-3 mb-3 enfant-form">
          {{ form.id }}
          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Prénom</label>{{ form.prenom }}
              <div class="text-danger small">{{ form.prenom.errors }}</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Solde points</label>{{ form.solde_points }}
              <div class="text-danger small">{{ form.solde_points.errors }}</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Email (facultatif)</label>{{ form.email }}
              <div class="text-danger small">{{ form.email.errors }}</div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Mot de passe</label>
              <div class="input-group">
                {{ form.new_password }}
                <button class="btn btn-outline-secondary toggle-password" type="button">
                  <i class="bi bi-eye"></i>
                </button>
              </div>
              <div class="form-text">Laisser vide pour conserver le mot de passe actuel.</div>
              <div class="text-danger small">{{ form.new_password.errors }}</div>
            </div>
          </div>
          <div class="form-check mt-2">
            {{ form.DELETE }} <label class="form-check-label">Retirer de la famille</label>
          </div>
        </div>
      {% endfor %}
      </div>
    </div>

    <div class="d-flex gap-2 justify-content-end">
      <button type="submit" class="btn btn-primary">Enregistrer</button>
    </div>
  </form>

  <form method="post" class="mt-4" onsubmit="return confirm('Supprimer votre compte parent ? Cette action est irréversible.');">
    {% csrf_token %}
    <input type="hidden" name="delete_self" value="1">
    <button class="btn btn-outline-danger">Supprimer mon compte parent</button>
  </form>
</div>

<script>
  // JS duplication formsets (inchangé)
  document.getElementById('add-parent').addEventListener('click', () => {
    const container = document.getElementById('parents-container');
    const totalInput = container.querySelector('input[name="parents-TOTAL_FORMS"]');
    const total = parseInt(totalInput.value, 10);
    const first = container.querySelector('.parent-form');
    const clone = first.cloneNode(true);

    clone.querySelectorAll('input').forEach(inp => {
      if (inp.type === 'checkbox') { inp.checked = false; return; }
      inp.value = '';
      inp.name = inp.name.replace(`parents-0-`, `parents-${total}-`);
      inp.id   = inp.id.replace(`parents-0-`, `parents-${total}-`);
    });
    container.appendChild(clone);
    totalInput.value = total + 1;
  });

  document.getElementById('add-enfant').addEventListener('click', () => {
    const container = document.getElementById('enfants-container');
    const totalInput = container.querySelector('input[name="enfants-TOTAL_FORMS"]');
    const total = parseInt(totalInput.value, 10);
    const first = container.querySelector('.enfant-form');
    const clone = first.cloneNode(true);

    clone.querySelectorAll('input').forEach(inp => {
      if (inp.type === 'checkbox') { inp.checked = false; return; }
      inp.value = '';
      inp.name = inp.name.replace(`enfants-0-`, `enfants-${total}-`);
      inp.id   = inp.id.replace(`enfants-0-`, `enfants-${total}-`);
    });
    container.appendChild(clone);
    totalInput.value = total + 1;
  });
</script>
{% endblock %}

{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container my-4 pb-5">
  <h1 class="page-title page-title display-6 mb-4">
    <span class="title-chip">Créer un compte famille</span>
  </h1>

  <p class="text-center bg-light p-3 rounded shadow-sm">
  En créant un compte, vous acceptez que vos données soient utilisées 
  uniquement pour le bon fonctionnement de l’application, conformément à notre 
  <a href="{% url 'confidentialite' %}" target="_blank" rel="noopener">Politique de confidentialité</a>.
  </p>

  <form method="post" novalidate>
    {% csrf_token %}

    <div class="card mb-4">
      <div class="card-header fw-bold">Famille</div>
      <div class="card-body">
        {{ famille_form.non_field_errors }}
        <div class="mb-3">
          <label class="form-label">Nom de la famille</label>
          {{ famille_form.nom }}
          {{ famille_form.nom.errors }}
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold">Parents</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-parent">+ Ajouter un parent</button>
      </div>
      <div class="card-body" id="parents-container">
        {{ parent_formset.management_form }}
        {% for form in parent_formset %}
          <div class="border rounded p-3 mb-3 parent-form">
            {{ form.non_field_errors }}
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Prénom</label>{{ form.first_name }}{{ form.first_name.errors }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Nom</label>{{ form.last_name }}{{ form.last_name.errors }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>{{ form.email }}{{ form.email.errors }}
              </div>

              <!-- Mot de passe avec bouton œil -->
              <div class="col-md-3">
                <label class="form-label">Mot de passe</label>
                <div class="input-group">
                  {{ form.password1 }}
                  <button class="btn btn-outline-secondary toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                {{ form.password1.errors }}
              </div>

              <div class="col-md-3">
                <label class="form-label">Confirmer</label>
                <div class="input-group">
                  {{ form.password2 }}
                  <button class="btn btn-outline-secondary toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                {{ form.password2.errors }}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-bold">Enfants</span>
        <button type="button" class="btn btn-sm btn-outline-primary" id="add-enfant">+ Ajouter un enfant</button>
      </div>
      <div class="card-body" id="enfants-container">
        {{ enfant_formset.management_form }}
        {% for form in enfant_formset %}
          <div class="border rounded p-3 mb-3 enfant-form">
            {{ form.non_field_errors }}
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Prénom</label>{{ form.prenom }}{{ form.prenom.errors }}
              </div>
              <div class="col-md-6">
                <label class="form-label">Email (facultatif)</label>{{ form.email }}{{ form.email.errors }}
              </div>

              <!-- Mot de passe enfant -->
              <div class="col-md-6">
                <label class="form-label">Mot de passe (si email)</label>
                <div class="input-group">
                  {{ form.password }}
                  <button class="btn btn-outline-secondary toggle-password" type="button">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
                {{ form.password.errors }}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary">Créer le compte</button>
    </div>
  </form>
</div>

<script>
  

  // Duplication simple de formulaires côté client pour formsets
  function addForm(prefix, containerId) {
    const container = document.getElementById(containerId);
    const totalFormsInput = container.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`);
    const total = parseInt(totalFormsInput.value, 10);
    const firstForm = container.querySelector(`.${prefix === 'parents' ? 'parent-form' : 'enfant-form'}`);
    const newForm = firstForm.cloneNode(true);

    // reset champs
    const re = new RegExp(`${prefix}-\\d+-`);
    newForm.querySelectorAll('input').forEach(inp => {
      if (inp.type === 'checkbox') inp.checked = false; else inp.value = '';
      if (inp.name) inp.name = inp.name.replace(re, `${prefix}-${total}-`);
      if (inp.id)   inp.id   = inp.id.replace(re, `${prefix}-${total}-`);
    });


    container.appendChild(newForm);
    totalFormsInput.value = total + 1;
    return newForm; 
  }

  document.getElementById('add-parent').addEventListener('click', () => addForm('parents', 'parents-container'));
  document.getElementById('add-enfant').addEventListener('click', () => addForm('enfants', 'enfants-container'));
</script>
<script>
  // --- Auto-remplir le nom de famille -> nom des parents ---
  const familyInput = document.querySelector('input[name="nom"]'); // champ "Nom de la famille"
  const parentsContainer = document.getElementById('parents-container');

  function markAutofilled(input, val) {
    input.value = val;
    input.dataset.autofilled = '1'; // on marque comme auto-rempli
  }

  function updateParentsLastNames(fromVal) {
    const val = (fromVal || '').trim();
    parentsContainer.querySelectorAll('input[name$="-last_name"]').forEach(inp => {
      // On ne remplace que si vide OU déjà auto-rempli
      if (!inp.value || inp.dataset.autofilled === '1') {
        markAutofilled(inp, val);
      }
    });
  }

  if (familyInput) {
    // Quand on tape le nom de la famille, on répercute
    familyInput.addEventListener('input', (e) => updateParentsLastNames(e.target.value));
  }

  // Si l'utilisateur tape lui-même le nom du parent, on désactive l’auto-remplissage pour ce champ
  parentsContainer.addEventListener('input', (e) => {
    const t = e.target;
    if (t.matches('input[name$="-last_name"]')) {
      t.dataset.autofilled = '0';
    }
  });

  // --- Intégration avec ton bouton "Ajouter un parent" ---
  function afterAddParent(newForm) {
    const lastNameInput = newForm.querySelector('input[name$="-last_name"]');
    if (lastNameInput) {
      const famVal = familyInput ? familyInput.value.trim() : '';
      // Auto-remplir au moment de l’ajout (sans forcer si l’utilisateur modifie après)
      markAutofilled(lastNameInput, famVal);
    }
  }

  // On monkey-patche ta fonction addForm pour appeler afterAddParent quand on ajoute un parent
  const _origAddForm = addForm;
  window.addForm = function(prefix, containerId) {
    const newForm = _origAddForm(prefix, containerId); // on récupère le nouveau form si possible
    // Si on a ajouté un parent, on initialise son nom
    if (prefix === 'parents') {
      // _origAddForm ne renvoie rien : on récupère le dernier bloc ajouté
      const container = document.getElementById(containerId);
      const newlyAdded = container.querySelectorAll('.parent-form');
      if (newlyAdded.length) {
        afterAddParent(newlyAdded[newlyAdded.length - 1]);
      }
    }
    return newForm;
  };

  // Au chargement, initialiser les formulaires déjà présents
  updateParentsLastNames(familyInput ? familyInput.value : '');
</script>

{% endblock %}
